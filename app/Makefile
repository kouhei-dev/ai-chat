# AIãƒãƒ£ãƒƒãƒˆ - Makefile
# ä½¿ç”¨æ–¹æ³•: make [target]

.PHONY: help init dev test test-e2e lint format db-up db-down db-studio deploy clean

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help:
	@echo "åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:"
	@echo ""
	@echo "  åˆæœŸåŒ–ãƒ»ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—:"
	@echo "    make init          - åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€DBèµ·å‹•ã€Prismaè¨­å®šï¼‰"
	@echo "    make install       - npmä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
	@echo ""
	@echo "  é–‹ç™º:"
	@echo "    make dev           - é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•"
	@echo ""
	@echo "  ãƒ†ã‚¹ãƒˆ:"
	@echo "    make test          - å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
	@echo "    make test-e2e      - E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
	@echo "    make test-all      - å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
	@echo ""
	@echo "  ã‚³ãƒ¼ãƒ‰å“è³ª:"
	@echo "    make lint          - ESLintãƒã‚§ãƒƒã‚¯"
	@echo "    make format        - Prettieræ•´å½¢"
	@echo "    make check         - lint + format ãƒã‚§ãƒƒã‚¯"
	@echo ""
	@echo "  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹:"
	@echo "    make db-up         - MongoDBèµ·å‹•"
	@echo "    make db-down       - MongoDBåœæ­¢"
	@echo "    make db-studio     - Prisma Studioèµ·å‹•"
	@echo "    make db-push       - ã‚¹ã‚­ãƒ¼ãƒã‚’DBã«åæ˜ "
	@echo ""
	@echo "  ãƒ‡ãƒ—ãƒ­ã‚¤:"
	@echo "    make deploy        - Cloud Runã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆPROJECT_IDå¿…é ˆï¼‰"
	@echo ""
	@echo "  ãã®ä»–:"
	@echo "    make clean         - ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’å‰Šé™¤"

# ===========================================
# åˆæœŸåŒ–ãƒ»ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
# ===========================================

# å®Œå…¨ãªåˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
init: install db-up db-wait db-generate db-push
	@echo "âœ… åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"
	@echo "ğŸ‘‰ 'make dev' ã§é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã§ãã¾ã™"

# npmä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
install:
	npm install

# ===========================================
# é–‹ç™º
# ===========================================

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
dev:
	npm run dev

# ===========================================
# ãƒ†ã‚¹ãƒˆ
# ===========================================

# å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ï¼‰
test:
	npm run test

# å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆ1å›å®Ÿè¡Œï¼‰
test-run:
	npm run test:run

# E2Eãƒ†ã‚¹ãƒˆ
test-e2e:
	npm run test:e2e

# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
test-all: test-run test-e2e

# ===========================================
# ã‚³ãƒ¼ãƒ‰å“è³ª
# ===========================================

# ESLintãƒã‚§ãƒƒã‚¯
lint:
	npm run lint

# ESLintè‡ªå‹•ä¿®æ­£
lint-fix:
	npm run lint:fix

# Prettieræ•´å½¢
format:
	npm run format

# Prettieræ•´å½¢ãƒã‚§ãƒƒã‚¯
format-check:
	npm run format:check

# lint + format ãƒã‚§ãƒƒã‚¯
check: lint format-check

# ===========================================
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
# ===========================================

# MongoDBèµ·å‹•
db-up:
	docker compose up -d mongodb

# MongoDBåœæ­¢
db-down:
	docker compose down

# MongoDBã®èµ·å‹•å¾…æ©Ÿ
db-wait:
	@echo "MongoDBã®èµ·å‹•ã‚’å¾…æ©Ÿä¸­..."
	@until docker compose ps mongodb | grep -q "healthy"; do \
		echo "  waiting..."; \
		sleep 5; \
	done
	@echo "MongoDBãŒèµ·å‹•ã—ã¾ã—ãŸ"

# Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”Ÿæˆ
db-generate:
	npm run db:generate

# ã‚¹ã‚­ãƒ¼ãƒã‚’DBã«åæ˜ 
db-push:
	npm run db:push

# Prisma Studioèµ·å‹•
db-studio:
	npm run db:studio

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ
db-test:
	npm run db:test

# ===========================================
# ãƒ‡ãƒ—ãƒ­ã‚¤
# ===========================================

# Cloud Runã«ãƒ‡ãƒ—ãƒ­ã‚¤
# ä½¿ç”¨æ–¹æ³•: make deploy PROJECT_ID=your-project-id
deploy:
ifndef PROJECT_ID
	$(error PROJECT_ID is required. Usage: make deploy PROJECT_ID=your-project-id)
endif
	./scripts/deploy.sh $(PROJECT_ID)

# ===========================================
# ãã®ä»–
# ===========================================

# ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’å‰Šé™¤
clean:
	rm -rf .next
	rm -rf node_modules/.cache
	@echo "âœ… ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"

# node_modulesã‚‚å«ã‚ã¦å®Œå…¨å‰Šé™¤
clean-all: clean
	rm -rf node_modules
	@echo "âœ… node_modulesã‚’å‰Šé™¤ã—ã¾ã—ãŸ"
	@echo "ğŸ‘‰ 'make install' ã§å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„"
